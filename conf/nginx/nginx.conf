# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    server
    {
        listen localhost:80;
        listen [::1]:80 ipv6only=on;
	server_name souvik.me;
    	return 301 https://$server_name$request_uri;
    }
    server
    {
	listen 127.0.0.1:443 default_server;
	listen [::1]:443 default_server ipv6only=on;
	add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
	ssl on;
	ssl_stapling on;
	ssl_stapling_verify on;
	root /souvik.me/website;
	index index.html index.htm;
	ssl_certificate /etc/letsencrypt/live/souvik.me/cert.pem;
	ssl_certificate_key /etc/letsencrypt/live/souvik.me/privkey.pem;
	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	ssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;
	ssl_prefer_server_ciphers on;
	ssl_session_cache shared:SSL:30m;
	ssl_session_timeout 30m;
	ssl_buffer_size 8k;
	ssl_trusted_certificate /etc/letsencrypt/live/souvik.me/fullchain.pem;
	ssl_dhparam /souvik.me/ssl/souvik_me_dhparam.pem;

	sub_filter '</head>' "<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73305012-1', 'auto');
  ga('send', 'pageview');

</script></head>";

	location /
	{
		try_files $uri $uri/ $uri.html =404;
	}

	location /blog
	{
		alias /souvik.me/website/blog/blog/_site/;
		rewrite ^/(.*)/$ /$1 permanent;
		index /blog/index.html;
		error_page 404 = @blog_index;
		try_files $uri $uri.html $uri/index.html =404;
	}
	location @blog_index
	{
		return 301 /blog;
	}

	location /picard/api
	{
		proxy_pass http://127.0.0.1:8991;
	}

	location /picard/static
	{
		index index.html;
		alias /souvik.me/website/projects/picard/server/picard/static/;
	}

	location /squirrelmail
	{
		alias /usr/share/squirrelmail;
		index index.php index.html index.htm;
                location ~ /squirrelmail/src/(.*\.php)$
		{
			fastcgi_split_path_info ^(.+?\.php)(/.*)?$;
			fastcgi_pass unix:/run/php-fpm.sock;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME /usr/share/squirrelmail/src/$1;
			include fastcgi_params;
		}

		location ~ /squirrelmail/index.php$
		{
			fastcgi_split_path_info ^(.+?\.php)(/.*)?$;
			fastcgi_pass unix:/run/php-fpm.sock;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME /usr/share/squirrelmail/index.php;
			include fastcgi_params;
		}

		location ~ (.*\.php)$
		{
			return 403;
		}

	}

	location /cgit-data
	{
		alias /usr/share/cgit/;
	}

	location /cgit
	{
		fastcgi_pass unix:/run/fcgiwrap.sock;
		fastcgi_param SCRIPT_FILENAME /var/www/cgi-bin/cgit;
		fastcgi_split_path_info ^((?U).*)cgit(.*)$;
		fastcgi_param PATH_INFO $fastcgi_path_info;
		fastcgi_param QUERY_STRING $query_string;
		include fastcgi_params;
	}
    }

    server
    {
	listen 127.0.0.1:80;
    	listen 127.0.0.1:443;
	listen [::1]:80;
	listen [::1]:443;
	server_name ~^((?!souvik.me));
	return 410;
    }
}
