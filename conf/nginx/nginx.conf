# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;

    server
    {
        listen 80;
        listen [::]:80 ipv6only=on;
	server_name centos7.souvik.me;
    	return 301 https://$server_name$request_uri;
    }
    server 
    {
	listen 443 default_server;
	listen [::]:443 default_server ipv6only=on;
	add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
	ssl on;
	root /souvik.me/website;
	index index.html index.htm;
	ssl_certificate /souvik.me/ssl/souvik_me.crt;
	ssl_certificate_key /souvik.me/ssl/souvik_me.key;
	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

	sub_filter '</head>' '<script type="text/javascript">
      var _paq = _paq || [];
      _paq.push(["trackPageView"]);
      _paq.push(["enableLinkTracking"]);
      (function() {
        var u="//souvik.me/piwik/";
        _paq.push(["setTrackerUrl", u+"piwik.php"]);
        _paq.push(["setSiteId", 1]);
        var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0];
        g.type="text/javascript"; g.async=true; g.defer=true; g.src=u+"piwik.js"; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <noscript><p><img src="//souvik.me/piwik/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript></head>';


	location /
	{
		try_files $uri $uri/ $uri.html =404;
	}

	location /blog
	{
		alias /souvik.me/website/blog/blog/_site/;
		if (-f $request_filename)
		{
			break;
		}
		if (-d $request_filename)
		{
			break;
		}
		rewrite ^/blog/((?U).*)/?$ /blog/$1.html last;
	}

	location /picard/api
	{
		proxy_pass http://127.0.0.1:8991;
	}

	location /picard/static
	{
		alias /souvik.me/website/projects/picard/server/picard/static;
	}

	location /squirrelmail
	{
		alias /usr/share/squirrelmail;
		index index.php index.html index.htm;
                location ~ /squirrelmail/src/(.*\.php)$
		{
			fastcgi_split_path_info ^(.+?\.php)(/.*)?$;
			fastcgi_pass 127.0.0.1:9000;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME /usr/share/squirrelmail/src/$1;
			include fastcgi_params;
		}

		location ~ /squirrelmail/index.php$
		{
			fastcgi_split_path_info ^(.+?\.php)(/.*)?$;
			fastcgi_pass 127.0.0.1:9000;
			fastcgi_index index.php;
			fastcgi_param SCRIPT_FILENAME /usr/share/squirrelmail/index.php;
			include fastcgi_params;
		}

		location ~ (.*\.php)$
		{
			return 403;
		}
		
	}

	location /piwik
	{
		alias /souvik.me/piwik;
		index index.php index.html index.htm;
		location /piwik/index.php
		{
                        fastcgi_pass 127.0.0.1:9000;
                        fastcgi_index index.php;
                        fastcgi_param SCRIPT_FILENAME /souvik.me/piwik/index.php;
                        include fastcgi_params;
                }

		location /piwik/piwik.php
		{
                        fastcgi_pass 127.0.0.1:9000;
                        fastcgi_param SCRIPT_FILENAME /souvik.me/piwik/piwik.php;
                        include fastcgi_params;
                }
	}

	location /cgit-data
	{
		alias /usr/share/cgit/;
	}

	location /cgit
	{
		fastcgi_pass unix:/run/fcgiwrap.sock;
		fastcgi_param SCRIPT_FILENAME /var/www/cgi-bin/cgit;
		fastcgi_split_path_info ^((?U).*)cgit(.*)$;
		fastcgi_param PATH_INFO $fastcgi_path_info;
		fastcgi_param QUERY_STRING $query_string;
		include fastcgi_params;
	}
    }
}
